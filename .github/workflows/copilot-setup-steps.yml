name: Copilot setup steps

on:
  workflow_dispatch:
  push:
    branches:
      - refactor/v6

permissions:
  contents: read
  pull-requests: read
  issues: read
  id-token: write
  packages: read

env:
  NODE_VERSION: '24'
  AZDO_ORG_URL: 'https://dev.azure.com/jessehouwing-dev'

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org
          cache: npm

      - name: Ensure Azure CLI is installed
        run: |
          set -euo pipefail
          if command -v az >/dev/null 2>&1; then
            echo "Azure CLI already present"
          else
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi
          az version
          az extension add --name azure-devops

      - name: Ensure tfx-cli is installed
        run: |
          set -euo pipefail
          npm install --global tfx-cli
          tfx --version

      - name: Install dependencies
        run: npm ci

      - name: Setup summary
        run: |
          {
            echo "## Copilot setup summary"
            echo "- Node: ${NODE_VERSION}"
            echo "- Azure CLI: $(az version --query '"azure-cli"' -o tsv)"
            echo "- tfx-cli: $(tfx --version)"
          } >> "$GITHUB_STEP_SUMMARY"
