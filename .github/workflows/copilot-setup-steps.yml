name: Copilot setup steps

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  pull-requests: read
  issues: read
  id-token: write
  packages: read

env:
  NODE_VERSION: "24"
  AZDO_ORG_URL: "https://dev.azure.com/jessehouwing-dev"

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org
          cache: npm

      - name: Ensure Azure CLI is installed
        run: |
          set -euo pipefail
          if command -v az >/dev/null 2>&1; then
            echo "Azure CLI already present"
          else
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi
          az version

      - name: Ensure tfx-cli is installed
        run: |
          set -euo pipefail
          npm install --global tfx-cli
          tfx --version

      - name: Validate GitHub access
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "Checking GitHub API access..."
          gh --version
          gh api /rate_limit > /tmp/rate_limit.json
          echo "GitHub API access OK"

      - name: Configure npmjs authentication
        if: ${{ secrets.NPM_TOKEN != '' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          npm ping --registry=https://registry.npmjs.org
          echo "npmjs access OK"

      - name: Warn when npmjs token is missing
        if: ${{ secrets.NPM_TOKEN == '' }}
        run: |
          echo "::warning::NPM_TOKEN is not configured. Public package install works, but private npmjs access is unavailable."

      - name: Validate Azure DevOps access
        if: ${{ secrets.AZDO_PAT != '' }}
        env:
          AZDO_PAT: ${{ secrets.AZDO_PAT }}
        run: |
          set -euo pipefail
          auth_header=$(printf ":%s" "$AZDO_PAT" | base64 -w0)
          curl -fsS \
            -H "Authorization: Basic $auth_header" \
            "${AZDO_ORG_URL}/_apis/projects?api-version=7.1-preview.4" \
            > /tmp/azdo-projects.json
          echo "Azure DevOps access OK: ${AZDO_ORG_URL}"

      - name: Warn when Azure DevOps PAT is missing
        if: ${{ secrets.AZDO_PAT == '' }}
        run: |
          echo "::warning::AZDO_PAT is not configured. Access to ${AZDO_ORG_URL} is not validated."

      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci

      - name: Build workspace
        run: npm run build --if-present

      - name: Verify test runner availability
        run: npm run test --if-present

      - name: Setup summary
        env:
          HAS_NPM_TOKEN: ${{ secrets.NPM_TOKEN != '' }}
          HAS_AZDO_PAT: ${{ secrets.AZDO_PAT != '' }}
        run: |
          {
            echo "## Copilot setup summary"
            echo "- Node: ${NODE_VERSION}"
            echo "- Azure CLI: $(az version --query '"azure-cli"' -o tsv)"
            echo "- tfx-cli: $(tfx --version)"
            echo "- GitHub access: validated"
            if [ "${HAS_NPM_TOKEN}" = "true" ]; then
              echo "- npmjs access: validated"
            else
              echo "- npmjs access: not validated (missing NPM_TOKEN)"
            fi
            if [ "${HAS_AZDO_PAT}" = "true" ]; then
              echo "- Azure DevOps access: validated for ${AZDO_ORG_URL}"
            else
              echo "- Azure DevOps access: not validated (missing AZDO_PAT)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
