name: E2E - Marketplace Operations

# This workflow tests all marketplace-related operations
# Tests both main action and composite wrappers

on:
  workflow_dispatch:
    inputs:
      extension-version-suffix:
        description: 'Version suffix for test extension (e.g., run number)'
        required: false
        default: ''

  workflow_call:
    inputs:
      extension-version-suffix:
        description: 'Version suffix for test extension'
        required: false
        default: ''
        type: string

permissions:
  contents: read

jobs:
  # Test 1: Package operation
  test-package-main-action:
    name: Test Package (Main Action)
    runs-on: ubuntu-latest
    outputs:
      vsix-path: ${{ steps.package.outputs.vsix-path }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Package extension (Main Action)
        id: package
        uses: ./
        with:
          operation: 'package'
          root-folder: '.github/e2e-test-fixtures/sample-extension'
          output-path: './dist-e2e-main'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID || 'e2e-test-publisher' }}
          extension-id: 'e2e-test-extension-main'
          extension-version: '0.0.${{ inputs.extension-version-suffix || github.run_number }}'
          extension-visibility: 'private'
          update-tasks-version: 'true'
          update-tasks-id: 'true'
          tfx-version: 'built-in'

      - name: Verify package output
        run: |
          echo "VSIX Path: ${{ steps.package.outputs.vsix-path }}"
          ls -lh ./dist-e2e-main/*.vsix
          if [ ! -f "${{ steps.package.outputs.vsix-path }}" ]; then
            echo "ERROR: VSIX file not created"
            exit 1
          fi
          echo "✅ Package operation (main action) successful"

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-main-action
          path: ./dist-e2e-main/*.vsix
          retention-days: 7

  test-package-composite:
    name: Test Package (Composite)
    runs-on: ubuntu-latest
    outputs:
      vsix-path: ${{ steps.package.outputs.vsix-path }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Package extension (Composite)
        id: package
        uses: ./package
        with:
          root-folder: '.github/e2e-test-fixtures/sample-extension'
          output-path: './dist-e2e-composite'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID || 'e2e-test-publisher' }}
          extension-id: 'e2e-test-extension-composite'
          extension-version: '0.0.${{ inputs.extension-version-suffix || github.run_number }}'
          extension-visibility: 'private'
          update-tasks-version: 'true'
          update-tasks-id: 'true'
          tfx-version: 'built-in'

      - name: Verify package output
        run: |
          echo "VSIX Path: ${{ steps.package.outputs.vsix-path }}"
          ls -lh ./dist-e2e-composite/*.vsix
          if [ ! -f "${{ steps.package.outputs.vsix-path }}" ]; then
            echo "ERROR: VSIX file not created"
            exit 1
          fi
          echo "✅ Package operation (composite) successful"

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-composite
          path: ./dist-e2e-composite/*.vsix
          retention-days: 7

  # Test 2: Show operation (requires auth)
  test-show-operations:
    name: Test Show Operations
    runs-on: ubuntu-latest
    if: secrets.MARKETPLACE_TOKEN != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Show extension (Main Action)
        id: show-main
        uses: ./
        with:
          operation: 'show'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID || 'ms-devlabs' }}
          extension-id: ${{ secrets.E2E_EXISTING_EXTENSION_ID || 'vsts-developer-tools' }}

      - name: Verify show output (Main)
        run: |
          echo "Extension Metadata (Main): ${{ steps.show-main.outputs.extension-metadata }}"
          if [ -z "${{ steps.show-main.outputs.extension-metadata }}" ]; then
            echo "ERROR: No metadata returned from show operation (main)"
            exit 1
          fi
          echo "✅ Show operation (main action) successful"

      - name: Show extension (Composite)
        id: show-composite
        uses: ./show
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID || 'ms-devlabs' }}
          extension-id: ${{ secrets.E2E_EXISTING_EXTENSION_ID || 'vsts-developer-tools' }}

      - name: Verify show output (Composite)
        run: |
          echo "Extension Metadata (Composite): ${{ steps.show-composite.outputs.extension-metadata }}"
          if [ -z "${{ steps.show-composite.outputs.extension-metadata }}" ]; then
            echo "ERROR: No metadata returned from show operation (composite)"
            exit 1
          fi
          echo "✅ Show operation (composite) successful"

  # Test 3: Query Version operation
  test-query-version:
    name: Test Query Version Operations
    runs-on: ubuntu-latest
    if: secrets.MARKETPLACE_TOKEN != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Query version (Main Action)
        id: query-main
        uses: ./
        with:
          operation: 'query-version'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID || 'ms-devlabs' }}
          extension-id: ${{ secrets.E2E_EXISTING_EXTENSION_ID || 'vsts-developer-tools' }}
          version-action: 'None'

      - name: Verify query version output (Main)
        run: |
          echo "Current Version (Main): ${{ steps.query-main.outputs.current-version }}"
          echo "Proposed Version (Main): ${{ steps.query-main.outputs.proposed-version }}"
          if [ -z "${{ steps.query-main.outputs.current-version }}" ]; then
            echo "ERROR: No version returned from query-version operation (main)"
            exit 1
          fi
          echo "✅ Query version operation (main action) successful"

      - name: Query version with increment (Composite)
        id: query-composite
        uses: ./query-version
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID || 'ms-devlabs' }}
          extension-id: ${{ secrets.E2E_EXISTING_EXTENSION_ID || 'vsts-developer-tools' }}
          version-action: 'Patch'

      - name: Verify query version output (Composite)
        run: |
          echo "Current Version (Composite): ${{ steps.query-composite.outputs.current-version }}"
          echo "Proposed Version (Composite): ${{ steps.query-composite.outputs.proposed-version }}"
          if [ -z "${{ steps.query-composite.outputs.current-version }}" ]; then
            echo "ERROR: No version returned from query-version operation (composite)"
            exit 1
          fi
          echo "✅ Query version operation (composite) successful"

  # Test 4: Publish operation (optional, requires publisher access)
  test-publish-operations:
    name: Test Publish Operations
    runs-on: ubuntu-latest
    needs: [test-package-main-action, test-package-composite]
    if: secrets.MARKETPLACE_TOKEN != '' && secrets.E2E_PUBLISHER_ID != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Download VSIX (Main)
        uses: actions/download-artifact@v4
        with:
          name: vsix-main-action
          path: ./dist-main

      - name: Publish extension (Main Action - VSIX mode)
        uses: ./
        with:
          operation: 'publish'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publish-source: 'vsix'
          vsix-file: ./dist-main/*.vsix
          no-wait-validation: 'false'

      - name: Verify publish (Main)
        run: echo "✅ Publish operation (main action - VSIX mode) successful"

      - name: Publish extension (Composite - Manifest mode)
        uses: ./publish
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publish-source: 'manifest'
          root-folder: '.github/e2e-test-fixtures/sample-extension'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: 'e2e-test-extension-manifest'
          extension-version: '0.0.${{ inputs.extension-version-suffix || github.run_number }}'
          extension-visibility: 'private'
          no-wait-validation: 'false'

      - name: Verify publish (Composite)
        run: echo "✅ Publish operation (composite - Manifest mode) successful"

  # Test 5: Unpublish operation (cleanup after publish tests)
  test-unpublish-operations:
    name: Test Unpublish Operations
    runs-on: ubuntu-latest
    needs: test-publish-operations
    if: always() && secrets.MARKETPLACE_TOKEN != '' && secrets.E2E_PUBLISHER_ID != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Unpublish extension (Main Action)
        uses: ./
        continue-on-error: true
        with:
          operation: 'unpublish'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: 'e2e-test-extension-main'

      - name: Unpublish extension (Composite)
        uses: ./unpublish
        continue-on-error: true
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: 'e2e-test-extension-manifest'

      - name: Verify unpublish
        run: echo "✅ Unpublish operations completed (errors ignored for non-existent extensions)"

  report-results:
    name: Report Test Results
    runs-on: ubuntu-latest
    needs: [test-package-main-action, test-package-composite, test-show-operations, test-query-version]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "=== Marketplace Operations E2E Test Results ==="
          echo "Package (Main): ${{ needs.test-package-main-action.result }}"
          echo "Package (Composite): ${{ needs.test-package-composite.result }}"
          echo "Show: ${{ needs.test-show-operations.result }}"
          echo "Query Version: ${{ needs.test-query-version.result }}"
          
          if [ "${{ needs.test-package-main-action.result }}" != "success" ] || \
             [ "${{ needs.test-package-composite.result }}" != "success" ]; then
            echo "❌ FAILED: Package operations"
            exit 1
          fi
          
          echo "✅ All marketplace operations completed successfully"
