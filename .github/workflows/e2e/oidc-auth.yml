name: E2E - OIDC Authentication

# This workflow tests GitHub Actions OIDC authentication integration
# It validates the token exchange with Azure and tests OIDC-authenticated operations

on:
  workflow_dispatch:
    inputs:
      skip-publish:
        description: 'Skip publish operation (only test auth)'
        required: false
        default: 'false'
      test-organization:
        description: 'Test organization for share/install operations'
        required: false
        default: ''

  # Optionally run before releases
  workflow_call:
    inputs:
      skip-publish:
        description: 'Skip publish operation (only test auth)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write  # Required for OIDC token
  contents: read

jobs:
  test-oidc-auth:
    name: Test OIDC Authentication
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      # Step 1: Authenticate with Azure using OIDC
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Step 2: Test package operation (doesn't require auth)
      - name: Package test extension
        id: package
        uses: ./
        with:
          operation: 'package'
          root-folder: '.github/e2e-test-fixtures/sample-extension'
          output-path: './dist-e2e'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: 'e2e-test-extension-oidc'
          extension-version: '0.0.${{ github.run_number }}'
          extension-visibility: 'private'
          update-tasks-version: 'true'
          update-tasks-id: 'true'
          tfx-version: 'built-in'

      - name: Verify package output
        run: |
          echo "VSIX Path: ${{ steps.package.outputs.vsix-path }}"
          ls -lh ./dist-e2e/*.vsix
          if [ ! -f "${{ steps.package.outputs.vsix-path }}" ]; then
            echo "ERROR: VSIX file not created"
            exit 1
          fi

      # Step 3: Test show operation with OIDC auth
      - name: Test show operation (OIDC)
        if: secrets.E2E_PUBLISHER_ID != ''
        uses: ./
        with:
          operation: 'show'
          auth-type: 'oidc'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ secrets.E2E_EXISTING_EXTENSION_ID }}

      # Step 4: Test publish operation with OIDC auth
      - name: Test publish operation (OIDC)
        if: inputs.skip-publish != 'true' && secrets.E2E_PUBLISHER_ID != ''
        uses: ./
        with:
          operation: 'publish'
          auth-type: 'oidc'
          publish-source: 'vsix'
          vsix-file: ${{ steps.package.outputs.vsix-path }}
          no-wait-validation: 'false'

      # Step 5: Test share operation with OIDC auth
      - name: Test share operation (OIDC)
        if: inputs.test-organization != '' && secrets.E2E_PUBLISHER_ID != ''
        uses: ./
        with:
          operation: 'share'
          auth-type: 'oidc'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: 'e2e-test-extension-oidc'
          share-with: ${{ inputs.test-organization }}

      # Step 6: Test install operation with OIDC auth
      - name: Test install operation (OIDC)
        if: inputs.test-organization != '' && secrets.E2E_PUBLISHER_ID != ''
        uses: ./
        with:
          operation: 'install'
          auth-type: 'oidc'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: 'e2e-test-extension-oidc'
          accounts: ${{ inputs.test-organization }}

      # Step 7: Upload VSIX as artifact
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-oidc-vsix
          path: ./dist-e2e/*.vsix
          retention-days: 7

  report-results:
    name: Report Test Results
    runs-on: ubuntu-latest
    needs: test-oidc-auth
    if: always()
    
    steps:
      - name: Report success
        if: needs.test-oidc-auth.result == 'success'
        run: |
          echo "✅ OIDC Authentication E2E tests PASSED"
          echo "All OIDC operations completed successfully"

      - name: Report failure
        if: needs.test-oidc-auth.result == 'failure'
        run: |
          echo "❌ OIDC Authentication E2E tests FAILED"
          echo "Check the logs above for details"
          exit 1
