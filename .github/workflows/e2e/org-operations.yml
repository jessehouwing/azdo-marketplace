name: E2E - Azure DevOps Organization Operations

# This workflow tests operations that interact with Azure DevOps organizations
# Tests: share, unshare, install, wait-for-installation

on:
  workflow_dispatch:
    inputs:
      test-organization:
        description: 'Test Azure DevOps organization URL or name'
        required: true
      extension-id:
        description: 'Extension ID to test with'
        required: false
        default: 'e2e-test-extension'

  workflow_call:
    inputs:
      test-organization:
        description: 'Test Azure DevOps organization URL or name'
        required: true
        type: string
      extension-id:
        description: 'Extension ID to test with'
        required: false
        default: 'e2e-test-extension'
        type: string

permissions:
  contents: read

jobs:
  # Prerequisite: Package extension for testing
  prepare-extension:
    name: Prepare Test Extension
    runs-on: ubuntu-latest
    outputs:
      vsix-path: ${{ steps.package.outputs.vsix-path }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Package test extension
        id: package
        uses: ./package
        with:
          root-folder: '.github/e2e-test-fixtures/sample-extension'
          output-path: './dist-e2e-org'
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          extension-version: '0.0.${{ github.run_number }}'
          extension-visibility: 'private'
          update-tasks-version: 'true'
          update-tasks-id: 'true'

      - name: Upload VSIX for other jobs
        uses: actions/upload-artifact@v4
        with:
          name: e2e-org-vsix
          path: ./dist-e2e-org/*.vsix
          retention-days: 7

  # Test 1: Share operation
  test-share-operations:
    name: Test Share Operations
    runs-on: ubuntu-latest
    needs: prepare-extension
    if: secrets.MARKETPLACE_TOKEN != '' && secrets.E2E_PUBLISHER_ID != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Share extension (Main Action)
        uses: ./
        with:
          operation: 'share'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          share-with: ${{ inputs.test-organization }}

      - name: Verify share (Main)
        run: echo "✅ Share operation (main action) successful"

      - name: Share extension (Composite)
        uses: ./share
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          share-with: ${{ inputs.test-organization }}

      - name: Verify share (Composite)
        run: echo "✅ Share operation (composite) successful"

  # Test 2: Install operation
  test-install-operations:
    name: Test Install Operations
    runs-on: ubuntu-latest
    needs: test-share-operations
    if: secrets.MARKETPLACE_TOKEN != '' && secrets.E2E_PUBLISHER_ID != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Install extension (Main Action)
        uses: ./
        with:
          operation: 'install'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          accounts: ${{ inputs.test-organization }}

      - name: Verify install (Main)
        run: echo "✅ Install operation (main action) successful"

      - name: Install extension (Composite)
        uses: ./install
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          accounts: ${{ inputs.test-organization }}

      - name: Verify install (Composite)
        run: echo "✅ Install operation (composite) successful"

  # Test 3: Wait for Installation operation
  test-wait-for-installation:
    name: Test Wait for Installation
    runs-on: ubuntu-latest
    needs: test-install-operations
    if: secrets.MARKETPLACE_TOKEN != '' && secrets.E2E_PUBLISHER_ID != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: e2e-org-vsix
          path: ./dist-vsix

      - name: Wait for installation (Main Action - with VSIX)
        uses: ./
        with:
          operation: 'wait-for-installation'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          service-url: ${{ inputs.test-organization }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          vsix-path: ./dist-vsix/*.vsix
          timeout-minutes: '5'
          polling-interval-seconds: '30'

      - name: Verify wait-for-installation (Main)
        run: echo "✅ Wait for installation (main action) successful"

      - name: Wait for installation (Composite - with manifest)
        uses: ./wait-for-installation
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          service-url: ${{ inputs.test-organization }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          manifest-path: '.github/e2e-test-fixtures/sample-extension/vss-extension.json'
          timeout-minutes: '5'
          polling-interval-seconds: '30'

      - name: Verify wait-for-installation (Composite)
        run: echo "✅ Wait for installation (composite) successful"

  # Test 4: Unshare operation (cleanup)
  test-unshare-operations:
    name: Test Unshare Operations
    runs-on: ubuntu-latest
    needs: test-wait-for-installation
    if: always() && secrets.MARKETPLACE_TOKEN != '' && secrets.E2E_PUBLISHER_ID != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Build extension tasks
        run: |
          npm install
          npm run build
          npm run bundle

      - name: Unshare extension (Main Action)
        uses: ./
        continue-on-error: true
        with:
          operation: 'unshare'
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          unshare-with: ${{ inputs.test-organization }}

      - name: Verify unshare (Main)
        run: echo "✅ Unshare operation (main action) completed"

      - name: Unshare extension (Composite)
        uses: ./unshare
        continue-on-error: true
        with:
          auth-type: 'pat'
          token: ${{ secrets.MARKETPLACE_TOKEN }}
          publisher-id: ${{ secrets.E2E_PUBLISHER_ID }}
          extension-id: ${{ inputs.extension-id }}
          unshare-with: ${{ inputs.test-organization }}

      - name: Verify unshare (Composite)
        run: echo "✅ Unshare operation (composite) completed"

  report-results:
    name: Report Test Results
    runs-on: ubuntu-latest
    needs: [prepare-extension, test-share-operations, test-install-operations, test-wait-for-installation]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "=== Azure DevOps Organization Operations E2E Test Results ==="
          echo "Prepare: ${{ needs.prepare-extension.result }}"
          echo "Share: ${{ needs.test-share-operations.result }}"
          echo "Install: ${{ needs.test-install-operations.result }}"
          echo "Wait for Installation: ${{ needs.test-wait-for-installation.result }}"
          
          if [ "${{ needs.prepare-extension.result }}" != "success" ] || \
             [ "${{ needs.test-share-operations.result }}" != "success" ] || \
             [ "${{ needs.test-install-operations.result }}" != "success" ] || \
             [ "${{ needs.test-wait-for-installation.result }}" != "success" ]; then
            echo "❌ FAILED: One or more organization operations failed"
            exit 1
          fi
          
          echo "✅ All organization operations completed successfully"
