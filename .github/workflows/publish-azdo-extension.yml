name: Publish private extension

on:
  workflow_dispatch:
    inputs:
      extension_id:
        description: Extension ID (base; OIDC job appends -oidc)
        required: true
        default: azdo-marketplace-extension
      initial_version:
        description: Initial version to use when extension does not yet exist
        required: true
        default: 6.0.0

permissions: {}

env:
  PUBLISHER_ID: jessehouwing

jobs:
  publish_oidc:
    name: Publish private (OIDC)
    runs-on: windows-latest
    environment:
      name: publisher-jessehouwing
      url: https://marketplace.visualstudio.com/items?itemName=${{env.PUBLISHER_ID}}.${{ inputs.extension_id }}

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 #v4.4.0
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Test
        shell: bash
        run: |
          stop_marker="$(uuidgen)"
          echo "::stop-commands::$stop_marker"
          npm run test
          echo "::$stop_marker::"

      - name: Lint
        run: npm run lint

      - name: Bundle
        run: npm run bundle

      - name: Azure login for OIDC
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 #v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - id: query
        name: Query next patch version
        continue-on-error: true
        uses: ./query-version
        with:
          auth-type: oidc
          publisher-id: ${{ env.PUBLISHER_ID }}
          extension-id: ${{ inputs.extension_id }}
          version-action: Patch

      - id: version
        name: Resolve version (query or initial)
        shell: bash
        run: |
          if [[ "${{ steps.query.outcome }}" == "success" && -n "${{ steps.query.outputs.proposed-version }}" ]]; then
            echo "value=${{ steps.query.outputs.proposed-version }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ inputs.initial_version }}" >> "$GITHUB_OUTPUT"
          fi

      - id: package
        name: Package VSIX
        uses: ./package
        with:
          publisher-id: ${{ env.PUBLISHER_ID }}
          extension-id: ${{ inputs.extension_id }}
          extension-version: ${{ steps.version.outputs.value }}
          extension-visibility: private
          update-tasks-version: patch
          update-tasks-id: true
          output-path: ${{ runner.temp }}

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: vsix-${{ inputs.extension_id }}-${{ steps.version.outputs.value }}
          path: ${{ steps.package.outputs.vsix-path }}
          if-no-files-found: error

      - name: Publish from VSIX
        uses: ./publish
        with:
          auth-type: oidc
          publish-source: vsix
          vsix-file: ${{ steps.package.outputs.vsix-path }}
          no-wait-validation: true

      - name: Wait for validation
        uses: ./wait-for-validation
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}

      - name: Share extension
        uses: ./share
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}
          accounts: |
            https://dev.azure.com/jessehouwing-dev

      - name: Install extension
        uses: ./install
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}
          accounts: |
            https://dev.azure.com/jessehouwing-dev

      - name: Wait for installation
        uses: ./wait-for-installation
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}
          accounts: |
            https://dev.azure.com/jessehouwing-dev
