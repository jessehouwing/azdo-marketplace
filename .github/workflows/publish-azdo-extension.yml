name: Publish private extension

on:
  workflow_dispatch:
    inputs:
      extension_id:
        description: Extension ID (base; OIDC job appends -oidc)
        required: true
        default: azdo-marketplace-extension
      initial_version:
        description: Initial version to use when extension does not yet exist
        required: true
        default: 6.0.0

permissions:
  contents: read
  id-token: write

env:
  PUBLISHER_ID: jessehouwing

jobs:
  publish_oidc:
    name: Publish private (OIDC)
    runs-on: ubuntu-latest
    environment: publisher-jessehouwing

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Test
        shell: bash
        run: |
          stop_marker="$(uuidgen)"
          echo "::stop-commands::$stop_marker"
          npm run test
          echo "::$stop_marker::"

      - name: Lint
        run: npm run lint

      - name: Bundle
        run: npm run bundle

      - name: Azure login for OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - id: query
        name: Query next patch version
        continue-on-error: true
        uses: jessehouwing/azdo-marketplace/query-version@main
        with:
          auth-type: oidc
          publisher-id: ${{ env.PUBLISHER_ID }}
          extension-id: ${{ inputs.extension_id }}
          version-action: Patch

      - id: version
        name: Resolve version (query or initial)
        shell: bash
        run: |
          if [[ "${{ steps.query.outcome }}" == "success" && -n "${{ steps.query.outputs.proposed-version }}" ]]; then
            echo "value=${{ steps.query.outputs.proposed-version }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ inputs.initial_version }}" >> "$GITHUB_OUTPUT"
          fi

      - id: package
        name: Package VSIX
        uses: jessehouwing/azdo-marketplace/package@main
        with:
          publisher-id: ${{ env.PUBLISHER_ID }}
          extension-id: ${{ inputs.extension_id }}
          extension-version: ${{ steps.version.outputs.value }}
          extension-visibility: private
          update-tasks-version: true
          update-tasks-id: true
          output-path: ${{ runner.temp }}

      - name: Publish from VSIX
        uses: jessehouwing/azdo-marketplace/publish@main
        with:
          auth-type: oidc
          publish-source: vsix
          vsix-file: ${{ steps.package.outputs.vsix-path }}
          no-wait-validation: true

      - name: Wait for validation
        uses: jessehouwing/azdo-marketplace/wait-for-validation@main
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}

      - name: Share extension
        uses: jessehouwing/azdo-marketplace/share@main
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}
          accounts: |
            https://dev.azure.com/jessehouwing-dev

      - name: Install extension
        uses: jessehouwing/azdo-marketplace/install@main
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}
          accounts: |
            https://dev.azure.com/jessehouwing-dev

      - name: Wait for installation
        uses: jessehouwing/azdo-marketplace/wait-for-installation@main
        with:
          auth-type: oidc
          vsix-path: ${{ steps.package.outputs.vsix-path }}
          accounts: |
            https://dev.azure.com/jessehouwing-dev
