# Migrate Azure Pipelines from v5 tasks to v6

This guide helps you migrate from the original multi-task v5 setup to the unified v6 task.

- **v5 model**: multiple Azure Pipelines tasks (package/publish/share/install/etc.)
- **v6 model**: one task, `azdo-marketplace@6`, with `operation` selecting the command

## What changes

In v6, all extension operations are routed through one task:

```yaml
- task: azdo-marketplace@6
  inputs:
    operation: publish
```

Supported v6 operations:

- `package`
- `publish`
- `unpublish`
- `share`
- `unshare`
- `install`
- `show`
- `query-version`
- `wait-for-validation`
- `wait-for-installation`

## Migration checklist

- Install/update to extension version 6 in your Azure DevOps organization.
- Replace each v5 task invocation with `azdo-marketplace@6`.
- Set `operation` to the equivalent command.
- Move authentication inputs to v6 connection inputs:
- `connectionType`
- `connectionNamePAT` (PAT)
- `connectionNameWorkloadIdentity` (Azure DevOps Workload Identity federation)
- `connectionNameAzureRm` (AzureRM OIDC / Entra workload federation)
- `connectionNameBasic` (basic auth)
- Update output variable references to v6 output names.
- Run the pipeline and verify publish/install/validation behavior.

## Command mapping (v5 to v6)

Use this mapping when converting existing YAML:

- Package Extension task → `azdo-marketplace@6` with `operation: package`
- Publish Extension task → `azdo-marketplace@6` with `operation: publish`
- Unpublish Extension task → `azdo-marketplace@6` with `operation: unpublish`
- Share Extension task → `azdo-marketplace@6` with `operation: share`
- Install Extension task → `azdo-marketplace@6` with `operation: install`
- Query Version task → `azdo-marketplace@6` with `operation: query-version`
- Wait for Validation task → `azdo-marketplace@6` with `operation: wait-for-validation`

Additional commands now available in v6:

- `unshare`
- `show`
- `wait-for-installation`

## Input contract changes

When migrating to v6, update account-related inputs as follows:

- `install` and `wait-for-installation` no longer use `service-url`.
- Use `accounts` (multi-line) for target organizations/collections.
- For Azure DevOps Services, `accounts` supports org names and URLs:
  - `ORG` (automatically expanded to `https://dev.azure.com/ORG`)
  - `https://dev.azure.com/ORG`
- For Azure DevOps Server/TFS, provide the full collection URL in `accounts` (for example `https://myserver/tfs/DefaultCollection`).
- `share` and `unshare` also use the `accounts` input in v6 for consistency.

### Renamed and consolidated inputs (v5 → v6)

Use this mapping carefully when updating YAML:

| v5 input pattern                                             | v6 input                                                 | Notes                                                                                                      |
| ------------------------------------------------------------ | -------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| `shareWith`, `unshareWith`, operation-specific account lists | `accounts`                                               | Single multi-line input for `install`, `share`, `unshare`, `wait-for-installation`.                        |
| `manifestGlobs`, `manifestPath`                              | `manifestFile`                                           | Single multi-line manifest input used by package, publish, wait-for-validation, and wait-for-installation. |
| `updateTasksVersion` (boolean) + `updateTasksVersionType`    | `updateTasksVersion` (`none`\|`major`\|`minor`\|`patch`) | `none` replaces the old disabled/false behavior.                                                           |
| `serviceUrl` for install/wait-install style flows            | `accounts`                                               | `install` and `wait-for-installation` no longer take `serviceUrl`; each account resolves to service URL.   |
| `extensionTag`                                               | _(removed)_                                              | Compose full value into `extensionId` yourself.                                                            |
| `outputVariable` custom name settings                        | _(removed)_                                              | Use built-in task output variables instead.                                                                |

Additional v6 package/publish inputs:

- `localizationRoot` for localization files in manifest-based flows.
- `extensionPricing` (`default`, `free`, `paid`) to override pricing metadata.
- Publish-time sharing input has been removed; use separate `share` operation with `accounts`.

## `extensionTag` in v6

In v6, `extensionTag` is no longer supported. Supply the full `extensionId` value yourself.

### Example using 2 variables

```yaml
variables:
  EXTENSION_ID_BASE: 'vsts-developer-tools-build-tasks'
  EXTENSION_ID_SUFFIX: '-dev'

steps:
  - task: azdo-marketplace@6
    inputs:
      operation: publish
      extensionId: '$(EXTENSION_ID_BASE)$(EXTENSION_ID_SUFFIX)'
```

## Before and after example

### Before (v5-style dedicated tasks)

```yaml
steps:
  - task: PackageAzureDevOpsExtension@5
    inputs:
      rootFolder: $(Build.SourcesDirectory)

  - task: PublishAzureDevOpsExtension@5
    inputs:
      connectedServiceName: MyMarketplaceConnection
```

### After (v6 unified task)

```yaml
steps:
  - task: azdo-marketplace@6
    name: packageExt
    inputs:
      operation: package
      rootFolder: $(Build.SourcesDirectory)
      outputPath: $(Build.ArtifactStagingDirectory)

  - task: azdo-marketplace@6
    inputs:
      operation: publish
      connectionType: PAT
      connectionNamePAT: MyMarketplaceConnection
      publishSource: vsix
      vsixFile: $(packageExt.vsixPath)
```

## Authentication changes

v6 supports four connection modes for non-package commands:

- PAT via `PAT`
- Workload Identity via `WorkloadIdentity`
- OIDC via `AzureRM`
- Basic auth via `Basic`

For OIDC setup and Entra workload federation details, see:

- [Authentication and OIDC](./authentication-and-oidc.md)
- [Azure Pipelines usage](./azure-pipelines.md)

## Output variables in v6 (Azure Pipelines)

Azure Pipelines v6 task outputs:

- `vsixPath`
- `extensionMetadata`
- `proposedVersion`
- `currentVersion`

If your v5 pipeline referenced legacy output variable names, update those references to the v6 names.

## Notes and compatibility

- Keep migration incremental: convert one operation at a time if needed.
- Prefer OIDC (`AzureRM`) for cloud-hosted pipelines to avoid long-lived PAT secrets.
- Validate required PAT scopes when using PAT-based connections.
