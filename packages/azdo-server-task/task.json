{
  "id": "231decda-22cb-4e83-b2f4-31fc86a0de1f",
  "name": "IsAzureDevOpsExtensionValidServer",
  "friendlyName": "Is valid Extension",
  "description": "Check Marketplace validation status.",
  "author": "Microsoft Corporation",
  "helpMarkDown": "",
  "category": "Deploy",
  "version": {
    "Major": 6,
    "Minor": 0,
    "Patch": 0
  },
  "visibility": ["Build", "Release"],
  "runsOn": ["Server", "ServerGate"],
  "groups": [
    {
      "name": "operationConfig",
      "displayName": "Operation Configuration",
      "isExpanded": true
    }
  ],
  "instanceNameFormat": "Check Marketplace validation status: $(extensionId)",
  "inputs": [
    {
      "name": "operation",
      "type": "pickList",
      "label": "Operation",
      "required": true,
      "defaultValue": "wait-for-validation",
      "helpMarkDown": "Operation to perform.",
      "groupName": "operationConfig",
      "aliases": ["method"],
      "options": {
        "wait-for-validation": "Wait for Validation"
      }
    },
    {
      "name": "connectionType",
      "type": "pickList",
      "label": "Connection Type",
      "required": true,
      "defaultValue": "VsTeam",
      "helpMarkDown": "Authentication method for marketplace operations.",
      "groupName": "operationConfig",
      "aliases": ["connectTo"],
      "options": {
        "VsTeam": "Visual Studio Marketplace"
      },
      "visibleRule": "operation = wait-for-validation"
    },
    {
      "name": "connectionName",
      "type": "connectedService:VstsMarketplacePublishing",
      "label": "Visual Studio Marketplace",
      "required": true,
      "helpMarkDown": "Service endpoint connection to install the extension.",
      "groupName": "operationConfig",
      "aliases": ["connectedServiceName"],
      "visibleRule": "operation = wait-for-validation && connectionType = VsTeam"
    },
    {
      "name": "publisherId",
      "type": "string",
      "label": "Publisher ID",
      "defaultValue": "",
      "required": true,
      "helpMarkDown": "Publisher ID of the extension to be installed.",
      "groupName": "operationConfig",
      "aliases": ["publisher-id", "publisher"],
      "visibleRule": "operation = wait-for-validation"
    },
    {
      "name": "extensionId",
      "type": "string",
      "label": "Extension ID",
      "defaultValue": "",
      "helpMarkDown": "Extension ID of the extension to be installed",
      "required": true,
      "groupName": "operationConfig",
      "aliases": ["extension-id", "extension"],
      "visibleRule": "operation = wait-for-validation"
    },
    {
      "name": "extensionTag",
      "type": "string",
      "label": "Extension Tag",
      "defaultValue": "",
      "helpMarkDown": "Extension Tag to append to the extension ID",
      "required": false,
      "groupName": "operationConfig",
      "aliases": ["extension-tag", "tag"],
      "visibleRule": "operation = wait-for-validation"
    },
    {
      "name": "extensionVersion",
      "type": "string",
      "label": "Extension Version",
      "defaultValue": "latest",
      "helpMarkDown": "Extension version (enter 'latest' or leave the value empty to check the last submitted version).",
      "required": false,
      "groupName": "operationConfig",
      "aliases": ["extension-version", "version"],
      "visibleRule": "operation = wait-for-validation"
    }
  ],
  "execution": {
    "HttpRequest": {
      "Execute": {
        "EndpointId": "$(connectionName)",
        "EndpointUrl": "$(endpoint.url)_apis/gallery/publishers/$(publisherId)/extensions/$(extensionId)$(extensionTag)?flags=1",
        "Method": "GET",
        "Body": "",
        "Headers": "{\"Content-Type\":\"application/json\"}",
        "WaitForCompletion": "false",
        "Expression": "or(eq(count(jsonpath('$.versions[?(@.version==''$(extensionVersion)'' && @.flags==''validated'')]')), 1), and(in('$(extensionVersion)', 'latest', ''), eq(jsonpath('$.versions[0].flags')[0], 'validated')))"
      }
    }
  }
}
