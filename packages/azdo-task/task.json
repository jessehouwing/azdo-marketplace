{
  "$schema": "https://raw.githubusercontent.com/Microsoft/azure-pipelines-task-lib/master/tasks.schema.json",
  "id": "a55bd3a0-30c6-463d-885e-851b7f663580",
  "name": "azdo-marketplace",
  "friendlyName": "Azure DevOps Extension Tasks",
  "description": "Package, publish, and manage Azure DevOps extensions and Visual Studio Marketplace extensions",
  "helpMarkDown": "[More Information](https://github.com/jessehouwing/azdo-marketplace)",
  "category": "Package",
  "author": "Jesse Houwing",
  "version": {
    "Major": 6,
    "Minor": 0,
    "Patch": 0
  },
  "instanceNameFormat": "Extension: $(operation)",
  "demands": [],
  "minimumAgentVersion": "2.144.0",
  "inputs": [
    {
      "name": "operation",
      "type": "pickList",
      "label": "Operation",
      "defaultValue": "package",
      "required": true,
      "helpMarkDown": "**Operation to perform:**\n\n- **Package**: Create a .vsix package file from manifest\n- **Publish**: Publish extension to Visual Studio Marketplace\n- **Unpublish**: Remove extension from marketplace\n- **Share**: Share private extension with specific organizations\n- **Unshare**: Unshare extension from organizations\n- **Install**: Install extension to Azure DevOps organizations\n- **Show**: Query and display extension metadata\n- **queryVersion**: Query latest extension version and optionally increment it\n- **waitForValidation**: Wait for extension validation to complete\n- **waitForInstallation**: Wait for tasks to be available after installation",
      "options": {
        "package": "Package - Create .vsix file",
        "publish": "Publish - Publish to marketplace",
        "unpublish": "Unpublish - Remove from marketplace",
        "share": "Share - Share with organizations",
        "unshare": "Unshare - Unshare from organizations",
        "install": "Install - Install to organizations",
        "show": "Show - Query extension metadata",
        "queryVersion": "Query Version - Query extension version",
        "waitForValidation": "Wait for Validation - Wait for validation",
        "waitForInstallation": "Wait for Installation - Wait for task availability"
      }
    },
    {
      "name": "connectionType",
      "type": "pickList",
      "label": "Connection Type",
      "required": true,
      "helpMarkDown": "**Authentication method** for marketplace operations:\n\n- **Visual Studio Team Services (PAT)**: Use Personal Access Token (recommended for most users)\n- **Azure Resource Manager (OIDC)**: Use workload identity federation with Azure CLI (no secrets needed, requires Azure RM service connection)\n- **Generic (Basic Auth)**: Use username/password authentication (for on-premises TFS/Azure DevOps Server)\n\n**Note**: Package operation does not require authentication.",
      "visibleRule": "operation != package",
      "options": {
        "PAT": "Azure DevOps Cloud (PAT)",
        "WorkloadIdentity": "Azure DevOps Cloud (WorkloadIdentity)",
        "AzureRM": "Azure Resource Manager (OIDC)",
        "Basic": "Azure DevOps Server (Basic Auth)"
      },
      "defaultValue": "PAT"
    },
    {
      "name": "connectionNamePAT",
      "type": "connectedService:cloud-marketplace-endpoint",
      "label": "Service Connection",
      "required": true,
      "helpMarkDown": "**Visual Studio Team Services service connection** configured with a Personal Access Token (PAT).\n\n**Required scopes**: Marketplace (Publish)\n\nCreate a PAT at: https://dev.azure.com/_usersSettings/tokens",
      "visibleRule": "operation != package && connectionType = PAT"
    },
    {
      "name": "connectionNameWorkloadIdentity",
      "label": "'Azure DevOps Service Connection",
      "helpMarkDown": "**Azure DevOps Workload Identity service connection** used to authenticate marketplace operations without PAT secrets.\n\nUse this connection when `connectionType = WorkloadIdentity` for operations such as `publish`, `install`, `share`, and validation commands.",
      "type": "connectedService:workloadidentityuser",
      "required": false,
      "properties": {
        "EditableOptions": "False",
        "MultiSelectFlatList": "False"
      },
      "visibleRule": "operation != package && connectionType = WorkloadIdentity"
    },
    {
      "name": "connectionNameAzureRm",
      "type": "connectedService:AzureRM",
      "label": "Azure RM Connection",
      "required": true,
      "helpMarkDown": "**Azure Resource Manager service connection** using workload identity federation (OIDC).\n\n**Benefits**: No secrets or PAT tokens needed - uses federated Azure credentials\n\n**Required**: Connection must have access to Visual Studio Marketplace scope (`499b84ac-1321-427f-aa17-267ca6975798`)",
      "visibleRule": "operation != package && connectionType = AzureRM"
    },
    {
      "name": "connectionNameBasic",
      "type": "connectedService:server-marketplace-endpoint",
      "label": "Basic Connection",
      "required": true,
      "helpMarkDown": "**Basic service connection** for basic authentication (username/password).\n\n**Use case**: On-premises TFS or Azure DevOps Server deployments\n\n**Note**: Not recommended for cloud-hosted Azure DevOps - use PAT authentication instead",
      "visibleRule": "operation != package && connectionType = Basic"
    },
    {
      "name": "publisherId",
      "type": "string",
      "label": "Publisher ID",
      "required": false,
      "helpMarkDown": "**Publisher ID** that owns the extension.\n\n- Must match publisher in manifest (or override it)\n- Optional when `vsixFile` is supplied for operations that support VSIX identity fallback\n- Required for `show` and `queryVersion`\n- Alphanumeric with hyphens, dots, underscores only\n\n**Example**: `mycompany` or `my-publisher-id`"
    },
    {
      "name": "extensionId",
      "type": "string",
      "label": "Extension ID",
      "required": false,
      "helpMarkDown": "**Extension ID** - unique identifier within the publisher namespace.\n\n- Must match ID in manifest (or override it)\n- Combined with Publisher ID forms full extension identifier: `publisherId.extensionId`\n- Optional when `vsixFile` is supplied for operations that support VSIX identity fallback\n- Required for `show` and `queryVersion`\n- Alphanumeric with hyphens, dots, underscores only\n\n**Example**: `my-extension` or `azure-devops-tasks`"
    },
    {
      "name": "use",
      "type": "pickList",
      "label": "Use",
      "required": true,
      "defaultValue": "manifest",
      "helpMarkDown": "**Input source mode** for operations that support manifest or VSIX input.\n\n- **Manifest files**: Use `manifestFile` (and optional `localizationRoot`) from the current working directory\n- **VSIX file**: Use `vsixFile`",
      "visibleRule": "operation = package || operation = publish || operation = waitForInstallation",
      "options": {
        "manifest": "Manifest files",
        "vsix": "VSIX file"
      }
    },
    {
      "name": "localizationRoot",
      "type": "filePath",
      "label": "Localization Root Folder",
      "required": false,
      "helpMarkDown": "**Folder containing localization files** for multi-language support.\n\n- Should contain language-specific resource files\n- Typically structured as: `localization/{locale}/resources.resjson`\n- If not specified, no localization is included\n\n**Example**: `$(Build.SourcesDirectory)/localization`",
      "visibleRule": "use = manifest && operation != waitForInstallation"
    },
    {
      "name": "manifestFile",
      "type": "multiLine",
      "label": "Manifest File(s)",
      "required": false,
      "helpMarkDown": "**Manifest file path(s)** (one per line).\n\n- Defaults to `vss-extension.json` if not specified\n- Supports multiple manifest files\n- Paths are relative to the current working directory\n\n**Examples**:\n- `vss-extension.json`\n- `manifests/dev/vss-extension.json`\n- `manifests/prod/vss-extension.json`",
      "visibleRule": "use = manifest"
    },
    {
      "name": "manifestFileJs",
      "type": "filePath",
      "label": "Manifest JS File",
      "required": false,
      "helpMarkDown": "**Path to a JavaScript manifest file** exported for tfx `--manifest-js`.\n\n- Optional alternative/addition to `manifestFile`\n- Must export a function returning manifest JSON\n- Path is relative to the current working directory",
      "visibleRule": "use = manifest && operation != waitForInstallation"
    },
    {
      "name": "overridesFile",
      "type": "filePath",
      "label": "Overrides File",
      "required": false,
      "helpMarkDown": "**Path to a JSON overrides file** for tfx `--overrides-file`.\n\n- Optional for manifest-based package/publish\n- Existing values are preserved unless overridden by other task inputs\n- Task-generated manifest changes are merged into this file",
      "visibleRule": "use = manifest && operation != waitForInstallation"
    },
    {
      "name": "vsixFile",
      "type": "filePath",
      "label": "VSIX File",
      "required": false,
      "helpMarkDown": "**Path to .vsix file** used for VSIX mode and VSIX identity fallback.\n\n- For publish: required when `use = vsix`\n- For install/share/unshare/unpublish/waitForValidation: reads publisher/extension identity from VSIX when IDs are omitted\n- For waitForInstallation: extracts task.json files from VSIX package\n\n**Example**: `$(Build.ArtifactStagingDirectory)/my-extension.vsix`\n\n**Note**: For waitForInstallation, use this OR expectedTasks/manifestFile, not multiple options",
      "visibleRule": "use = vsix || operation = unpublish || operation = share || operation = unshare || operation = install || operation = waitForValidation"
    },
    {
      "name": "extensionVersion",
      "type": "string",
      "label": "Extension Version",
      "required": false,
      "helpMarkDown": "**Override extension version** specified in manifest.\n\n- Must follow semantic versioning: `major.minor.patch`\n- Useful for CI/CD pipelines to inject build numbers\n- Supports pipeline variables\n\n**Examples**:\n- `1.2.3`\n- `$(Build.BuildNumber)`\n- `1.0.$(Build.BuildId)`",
      "visibleRule": "operation = package || operation = publish || operation = waitForValidation"
    },
    {
      "name": "extensionName",
      "type": "string",
      "label": "Extension Name",
      "required": false,
      "helpMarkDown": "**Override extension display name** shown in marketplace.\n\n- Overrides the name specified in manifest\n- Useful for creating branded variants (e.g., \"My Extension (Dev)\")\n- Does not affect the extension ID\n\n**Example**: `My Extension - Development`",
      "visibleRule": "operation = package || operation = publish"
    },
    {
      "name": "extensionVisibility",
      "type": "pickList",
      "label": "Extension Visibility",
      "required": false,
      "helpMarkDown": "**Override extension visibility** in marketplace.\n\n- **Private**: Only visible to organizations you share it with\n- **Public**: Visible to everyone in the marketplace\n- **Private Preview**: Private extension in preview mode\n- **Public Preview**: Public extension in preview mode\n\n**Note**: Private extensions must be explicitly shared with organizations",
      "visibleRule": "operation = package || operation = publish",
      "options": {
        "private": "Private",
        "public": "Public",
        "private_preview": "Private Preview",
        "public_preview": "Public Preview"
      }
    },
    {
      "name": "extensionPricing",
      "type": "pickList",
      "label": "Extension Pricing",
      "required": false,
      "defaultValue": "default",
      "helpMarkDown": "**Override extension pricing model**.\n\n- **Not set**: Use pricing from manifest\n- **Free**: Extension is free to use\n- **Paid**: Extension requires payment\n\n**Note**: Paid extensions require additional marketplace publisher verification",
      "visibleRule": "operation = package || operation = publish",
      "options": {
        "default": "Not set",
        "free": "Free",
        "paid": "Paid"
      }
    },
    {
      "name": "outputPath",
      "type": "filePath",
      "label": "Output Path",
      "required": false,
      "helpMarkDown": "**Output directory** for the generated/final .vsix file.\n\n- Available for `package` and `publish`\n- Defaults to current directory if not specified\n- Directory will be created if it doesn't exist\n- The actual filename is based on publisher.extension-id-version.vsix\n\n**Example**: `$(Build.ArtifactStagingDirectory)`\n\n**Output**: Full path is stored in `vsixPath` variable",
      "visibleRule": "operation = package || operation = publish"
    },
    {
      "name": "versionAction",
      "type": "pickList",
      "label": "Version Action",
      "required": false,
      "defaultValue": "none",
      "helpMarkDown": "**Action to apply to the marketplace version**.\n\n- **None**: Use the current latest marketplace version\n- **Major**: Increment major and reset minor/patch\n- **Minor**: Increment minor and reset patch\n- **Patch**: Increment patch\n\n**Example**: If latest is `1.2.3` and action is `Minor`, result is `1.3.0`",
      "visibleRule": "operation = queryVersion",
      "options": {
        "none": "None - Keep current version",
        "major": "Major - Increment major",
        "minor": "Minor - Increment minor",
        "patch": "Patch - Increment patch"
      }
    },
    {
      "name": "extensionVersionOverride",
      "type": "string",
      "label": "Version Override Variable",
      "required": false,
      "helpMarkDown": "**Variable name containing a version override**.\n\nIf set and the variable exists, that value is used instead of querying marketplace.\n\n**Example**: `MyVersionVar` (where `$(MyVersionVar)` resolves to `2.1.0`)",
      "visibleRule": "operation = queryVersion"
    },
    {
      "name": "setBuildNumber",
      "type": "boolean",
      "label": "Set Build Number",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "**Update the Azure Pipelines build number** to the resolved version.\n\n**Default**: false",
      "visibleRule": "operation = queryVersion"
    },
    {
      "name": "bypassValidation",
      "type": "boolean",
      "label": "Bypass Validation",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "**Skip extension validation checks** during package/publish.\n\n- Not recommended for production use\n- Use only when validation incorrectly fails\n- May result in extension rejection by marketplace\n\n**Default**: false (validation enabled)",
      "visibleRule": "operation = package || operation = publish"
    },
    {
      "name": "accounts",
      "type": "multiLine",
      "label": "Accounts",
      "required": true,
      "helpMarkDown": "**Azure DevOps accounts/organizations** (one per line).\n\n- Format: Full organization URL or organization name\n- Required for `install`, `share`, `unshare`, and `waitForInstallation`\n- For share/unshare: organizations to grant/remove extension access\n- For install/waitForInstallation: target organizations for installation checks\n\n**Examples**:\n```\nhttps://dev.azure.com/myorg1\nhttps://dev.azure.com/myorg2\n```\n\nOr just:\n```\nmyorg1\nmyorg2\n```",
      "visibleRule": "operation = install || operation = waitForInstallation || operation = share || operation = unshare"
    },
    {
      "name": "noWaitValidation",
      "type": "boolean",
      "label": "No Wait for Validation",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "**Do not wait for marketplace validation** to complete after publishing.\n\n- By default, task waits for validation (can take several minutes)\n- Enable this to publish and continue immediately\n- Extension may not be immediately available in marketplace\n\n**Use case**: When you want faster pipeline execution and don't need immediate marketplace availability\n\n**Default**: false (waits for validation)",
      "visibleRule": "operation = publish"
    },
    {
      "name": "updateTasksVersion",
      "type": "pickList",
      "label": "Update Task Versions",
      "required": false,
      "defaultValue": "none",
      "helpMarkDown": "**How to update task versions** within the extension to match the extension version.\n\n- **None**: Do not update task versions\n- **Major**: Replace major, minor, and patch\n- **Minor**: Keep major, replace minor and patch\n- **Patch**: Keep major and minor, replace patch only\n\n**Example with extension version `2.5.8` and task `1.3.7`**:\n- **Major** → `2.5.8`\n- **Minor** → `1.5.8`\n- **Patch** → `1.3.8`\n\n**Default**: none",
      "visibleRule": "operation = package || operation = publish",
      "options": {
        "none": "None - Do not update task versions",
        "major": "Major - Replace major, minor, patch",
        "minor": "Minor - Replace minor, patch",
        "patch": "Patch - Replace patch only"
      }
    },
    {
      "name": "updateTasksId",
      "type": "boolean",
      "label": "Update Task IDs",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "**Generate new deterministic task IDs** for all tasks in the extension.\n\n- Creates UUID v5 IDs based on publisher + extension + task name\n- Ensures consistent IDs across builds\n- Use when creating extension variants (e.g., dev, test versions)\n\n**Warning**: Changing task IDs creates new tasks in Azure DevOps. Existing pipelines won't automatically update.\n\n**Use case**: Creating parallel development/production versions of the same extension\n\n**Default**: false",
      "visibleRule": "operation = package || operation = publish"
    },
    {
      "name": "maxRetries",
      "type": "string",
      "label": "Max Retries",
      "required": false,
      "defaultValue": "10",
      "helpMarkDown": "**Maximum number of retry attempts** for extension validation.\n\n- Validation can take time as marketplace processes the extension\n- Task will retry with exponential backoff between min and max timeout\n- Set higher for complex extensions that take longer to validate\n\n**Default**: 10 attempts",
      "visibleRule": "operation = waitForValidation"
    },
    {
      "name": "minTimeout",
      "type": "string",
      "label": "Min Timeout (minutes)",
      "required": false,
      "defaultValue": "1",
      "helpMarkDown": "**Minimum timeout between validation retry attempts** (in minutes).\n\n- Initial wait time before first retry\n- Increases exponentially up to max timeout\n- Lower values check validation status more frequently\n\n**Default**: 1 minute",
      "visibleRule": "operation = waitForValidation"
    },
    {
      "name": "maxTimeout",
      "type": "string",
      "label": "Max Timeout (minutes)",
      "required": false,
      "defaultValue": "15",
      "helpMarkDown": "**Maximum timeout between validation retry attempts** (in minutes).\n\n- Maximum wait time between retry attempts\n- Timeout increases exponentially from min timeout\n- Higher values give extension more time to validate\n\n**Default**: 15 minutes",
      "visibleRule": "operation = waitForValidation"
    },
    {
      "name": "expectedTasks",
      "type": "multiLine",
      "label": "Expected Tasks (JSON)",
      "required": false,
      "helpMarkDown": "**Expected tasks as JSON array** - manually specify tasks to verify.\n\n**Format**: Array of objects with `name` and `versions` properties\n\n**Example**:\n```json\n[\n  {\"name\": \"MyTask\", \"versions\": [\"1.0.0\", \"1.0.1\"]},\n  {\"name\": \"AnotherTask\", \"versions\": [\"2.0.0\"]}\n]\n```\n\n**Note**: Use this OR auto-discovery options (manifestFile/vsixFile), not both",
      "visibleRule": "operation = waitForInstallation"
    },
    {
      "name": "timeoutMinutes",
      "type": "string",
      "label": "Timeout (minutes)",
      "required": false,
      "defaultValue": "10",
      "helpMarkDown": "**Maximum time to wait** for tasks to become available after installation (in minutes).\n\n- Task polls Azure DevOps at regular intervals\n- If tasks don't appear within timeout, verification fails\n- Increase for slower marketplace propagation\n\n**Default**: 10 minutes",
      "visibleRule": "operation = waitForInstallation"
    },
    {
      "name": "pollingIntervalSeconds",
      "type": "string",
      "label": "Polling Interval (seconds)",
      "required": false,
      "defaultValue": "30",
      "helpMarkDown": "**Interval between task availability checks** (in seconds).\n\n- How often to check if tasks are available\n- Lower values detect availability faster but create more API calls\n- Higher values reduce API load but delay detection\n\n**Recommendation**: 30-60 seconds is usually sufficient\n\n**Default**: 30 seconds",
      "visibleRule": "operation = waitForInstallation"
    },
    {
      "name": "tfxVersion",
      "type": "pickList",
      "label": "tfx-cli Version",
      "defaultValue": "built-in",
      "required": false,
      "properties": {
        "EditableOptions": "True"
      },
      "options": {
        "built-in": "built-in",
        "path": "path"
      },
      "helpMarkDown": "**Version of tfx-cli to use**:\n\n- **`built-in`** (default): Use tfx-cli bundled with this task\n- **`path`**: Use tfx-cli from system PATH\n- **Version spec**: Download specific version from npm (e.g., `^0.17`, `0.17.0`, `latest`)\n\n**Examples**: `built-in`, `path`, `^0.17`, `latest`"
    }
  ],
  "outputVariables": [
    {
      "name": "vsixPath",
      "description": "Path to the generated .vsix file (package operation only)"
    },
    {
      "name": "extensionMetadata",
      "description": "JSON metadata about the extension (show operation only)"
    },
    {
      "name": "proposedVersion",
      "description": "Proposed extension version after applying version action (queryVersion operation only)"
    },
    {
      "name": "currentVersion",
      "description": "Current marketplace version before applying version action (queryVersion operation only)"
    }
  ],
  "execution": {
    "Node20_1": {
      "target": "dist/main.js"
    },
    "Node24": {
      "target": "dist/main.js"
    }
  }
}
