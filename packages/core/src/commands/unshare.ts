/**
 * Unshare command - Unshares an extension from organizations
 */

import type { IPlatformAdapter } from '../platform.js';
import type { TfxManager } from '../tfx-manager.js';
import type { AuthCredentials } from '../auth.js';
import { ArgBuilder } from '../arg-builder.js';
import { resolveExtensionIdentity } from '../extension-identity.js';
import { normalizeOrganizationIdentifiers } from '../organization-utils.js';

/**
 * Options for unshare command
 */
export interface UnshareOptions {
  /** Publisher ID */
  publisherId?: string;
  /** Extension ID */
  extensionId?: string;
  /** Path to VSIX file to infer publisher/extension identity */
  vsixPath?: string;
  /** Array of organization names to unshare from */
  unshareWith: string[];
}

/**
 * Result from unshare command
 */
export interface UnshareResult {
  /** Whether extension was unshared successfully */
  success: boolean;
  /** Extension ID that was unshared */
  extensionId: string;
  /** Publisher ID */
  publisherId: string;
  /** Organizations unshared from */
  unsharedFrom: string[];
  /** Exit code from tfx */
  exitCode: number;
}

/**
 * Unshare an extension from organizations
 * @param options Unshare options
 * @param auth Authentication credentials
 * @param tfx TfxManager instance
 * @param platform Platform adapter
 * @returns Unshare result
 */
export async function unshareExtension(
  options: UnshareOptions,
  auth: AuthCredentials,
  tfx: TfxManager,
  platform: IPlatformAdapter
): Promise<UnshareResult> {
  if (!options.unshareWith || options.unshareWith.length === 0) {
    throw new Error('unshareWith must contain at least one organization');
  }

  const identity = await resolveExtensionIdentity(options, platform, 'unshare');

  platform.info(
    `Unsharing extension ${identity.publisherId}.${identity.extensionId} from ${options.unshareWith.length} organization(s)...`
  );

  const extensionId = identity.extensionId;
  const normalizedOrganizations = normalizeOrganizationIdentifiers(options.unshareWith);

  // Build tfx arguments
  const args = new ArgBuilder()
    .arg(['extension', 'unshare'])
    .flag('--json')
    .flag('--no-color')
    .option('--publisher', identity.publisherId)
    .option('--extension-id', extensionId)
    .flag('--unshare-with');

  // Add each organization
  normalizedOrganizations.forEach((org) => args.arg(org));

  // Authentication
  args.option('--service-url', auth.serviceUrl);

  if (auth.authType === 'pat') {
    args.option('--auth-type', 'pat');
    args.option('--token', auth.token);
    platform.setSecret(auth.token);
  } else if (auth.authType === 'basic') {
    args.option('--auth-type', 'basic');
    args.option('--username', auth.username);
    args.option('--password', auth.password);
    platform.setSecret(auth.password);
  }

  // Execute tfx
  const result = await tfx.execute(args.build(), { captureJson: true });

  if (result.exitCode !== 0) {
    platform.error(`tfx exited with code ${result.exitCode}`);
    throw new Error(`tfx extension unshare failed with exit code ${result.exitCode}`);
  }

  platform.info(`Successfully unshared extension from: ${normalizedOrganizations.join(', ')}`);

  return {
    success: true,
    extensionId,
    publisherId: identity.publisherId,
    unsharedFrom: normalizedOrganizations,
    exitCode: result.exitCode,
  };
}
